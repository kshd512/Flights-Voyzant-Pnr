package com.mmt.flights.odc.service.tasks;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.mmt.api.rxflow.FlowState;
import com.mmt.flights.common.constants.FlowStateKey;
import com.mmt.flights.odc.prepayment.DateChangePrePaymentRequest;
import com.mmt.flights.odc.prepayment.DateChangePrePaymentResponse;
import com.mmt.flights.odc.tasks.ODCExchangePriceResponseAdapterTask;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.junit.MockitoJUnitRunner;

import java.io.IOException;

@RunWith(MockitoJUnitRunner.class)
public class ODCExchangePriceResponseAdapterTaskTest {

    @InjectMocks
    private ODCExchangePriceResponseAdapterTask task;

    private ObjectMapper objectMapper = new ObjectMapper();

    private FlowState flowState;
    private String sampleJson;

    @Before
    public void setUp() throws IOException {
        flowState = new FlowState.Builder(System.currentTimeMillis()).build();

        // Load sample JSON from file
        sampleJson = "{\"OrderReshopRS\":{\"Document\":{\"Name\":\"API GATEWAY\",\"ReferenceVersion\":\"1.2\"},\"Party\":{\"Sender\":{\"TravelAgencySender\":{\"Name\":\"Diva Travels\",\"IATA_Number\":\"\",\"AgencyID\":\"Diva Travels\",\"Contacts\":{\"Contact\":[{\"EmailContact\":\"vakarram@gmail.com\"}]}}}},\"ShoppingResponseId\":\"1721375083437470641\",\"OfferResponseId\":\"1721375216410175645\",\"Success\":{},\"ReshopOffers\":[{\"ReshopOffer\":[{\"OfferID\":\"1227102711721375087885644107\",\"Owner\":\"WY\",\"OwnerName\":\"Oman Air\",\"BrandedFareOptions\":[],\"InstantTicket\":\"N\",\"Eticket\":\"false\",\"AllowHold\":\"Y\",\"TimeLimits\":{\"OfferExpirationDateTime\":\"2024-07-19T15:17:01\",\"PaymentExpirationDateTime\":\"2024-07-18 18:30:00\"},\"PassportRequired\":\"N\",\"BookingCurrencyCode\":\"LKR\",\"EquivCurrencyCode\":\"CAD\",\"HstPercentage\":\"\",\"RewardSettings\":{\"RewardAvailable\":\"N\",\"PointTypes\":[],\"PointValues\":{}},\"BookingFeeInfo\":{\"FeeType\":\"\",\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0.01},\"BasePrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0.01},\"TaxPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Commission\":{\"AgencyCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"AgencyYqCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"PortalCharges\":{\"Markup\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Surcharge\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Discount\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"ReshopDifferential\":{\"OriginalOrder\":{\"TotalPrice\":{\"BookingCurrencyPrice\":164510,\"EquivCurrencyPrice\":740.29},\"BasePrice\":{\"BookingCurrencyPrice\":91770,\"EquivCurrencyPrice\":412.96},\"TaxPrice\":{\"BookingCurrencyPrice\":72740,\"EquivCurrencyPrice\":327.33}},\"NewOffer\":{\"TotalPrice\":{\"BookingCurrencyPrice\":164510,\"EquivCurrencyPrice\":740.3},\"BasePrice\":{\"BookingCurrencyPrice\":91770,\"EquivCurrencyPrice\":412.97},\"TaxPrice\":{\"BookingCurrencyPrice\":72740,\"EquivCurrencyPrice\":327.33}},\"PenaltyAmount\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"ReshopDue\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0.01}}},\"AddOfferItem\":[{\"OfferItemID\":\"OFFERITEMID1\",\"Refundable\":\"false\",\"PassengerType\":\"ADT\",\"PassengerQuantity\":1,\"TotalPriceDetail\":{\"TotalAmount\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":256.99}},\"Service\":[{\"ServiceID\":\"SV1\",\"PassengerRefs\":\"ADT1\",\"FlightRefs\":\"Flight1\"}],\"FareDetail\":{\"PassengerRefs\":\"ADT1\",\"Price\":{\"TotalAmount\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":256.99},\"BaseAmount\":{\"BookingCurrencyPrice\":32760,\"EquivCurrencyPrice\":147.42},\"TaxAmount\":{\"BookingCurrencyPrice\":24350,\"EquivCurrencyPrice\":109.57},\"Commission\":{\"AgencyCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"AgencyYqCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"BookingFee\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"PortalCharges\":{\"Markup\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Surcharge\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Discount\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"Taxes\":[]}},\"ReshopDifferential\":{\"OriginalOrder\":{\"TotalPrice\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":257},\"BasePrice\":{\"BookingCurrencyPrice\":32760,\"EquivCurrencyPrice\":147.42},\"TaxPrice\":{\"BookingCurrencyPrice\":24350,\"EquivCurrencyPrice\":109.57}},\"NewOffer\":{\"TotalPrice\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":256.99},\"BasePrice\":{\"BookingCurrencyPrice\":32760,\"EquivCurrencyPrice\":147.42},\"TaxPrice\":{\"BookingCurrencyPrice\":24350,\"EquivCurrencyPrice\":109.57}},\"PenaltyAmount\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"ReshopDue\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":-0.01}}},\"FareComponent\":[{\"PriceClassRef\":\"PCR_1\",\"SegmentRefs\":\"Segment1\",\"FareBasis\":{\"FareBasisCode\":{\"Refs\":\"FG_1\",\"Code\":\"UELOIA\"},\"RBD\":\"U\",\"CabinType\":\"Y\",\"SeatLeft\":\"7\"}}]},{\"OfferItemID\":\"OFFERITEMID2\",\"Refundable\":\"false\",\"PassengerType\":\"ADT\",\"PassengerQuantity\":1,\"TotalPriceDetail\":{\"TotalAmount\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":256.99}},\"Service\":[{\"ServiceID\":\"SV1\",\"PassengerRefs\":\"ADT1\",\"FlightRefs\":\"Flight1\"}],\"FareDetail\":{\"PassengerRefs\":\"ADT1\",\"Price\":{\"TotalAmount\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":256.99},\"BaseAmount\":{\"BookingCurrencyPrice\":32760,\"EquivCurrencyPrice\":147.42},\"TaxAmount\":{\"BookingCurrencyPrice\":24350,\"EquivCurrencyPrice\":109.57},\"Commission\":{\"AgencyCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"AgencyYqCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"BookingFee\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"PortalCharges\":{\"Markup\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Surcharge\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Discount\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"Taxes\":[]}},\"ReshopDifferential\":{\"OriginalOrder\":{\"TotalPrice\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":257},\"BasePrice\":{\"BookingCurrencyPrice\":32760,\"EquivCurrencyPrice\":147.42},\"TaxPrice\":{\"BookingCurrencyPrice\":24350,\"EquivCurrencyPrice\":109.57}},\"NewOffer\":{\"TotalPrice\":{\"BookingCurrencyPrice\":57110,\"EquivCurrencyPrice\":256.99},\"BasePrice\":{\"BookingCurrencyPrice\":32760,\"EquivCurrencyPrice\":147.42},\"TaxPrice\":{\"BookingCurrencyPrice\":24350,\"EquivCurrencyPrice\":109.57}},\"PenaltyAmount\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"ReshopDue\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":-0.01}}},\"FareComponent\":[{\"PriceClassRef\":\"PCR_1\",\"SegmentRefs\":\"Segment1\",\"FareBasis\":{\"FareBasisCode\":{\"Refs\":\"FG_1\",\"Code\":\"UELOIA\"},\"RBD\":\"U\",\"CabinType\":\"Y\",\"SeatLeft\":\"7\"}}]},{\"OfferItemID\":\"OFFERITEMID3\",\"Refundable\":\"false\",\"PassengerType\":\"CHD\",\"PassengerQuantity\":1,\"TotalPriceDetail\":{\"TotalAmount\":{\"BookingCurrencyPrice\":50290,\"EquivCurrencyPrice\":226.31}},\"Service\":[{\"ServiceID\":\"SV1\",\"PassengerRefs\":\"CHD1\",\"FlightRefs\":\"Flight1\"}],\"FareDetail\":{\"PassengerRefs\":\"CHD1\",\"Price\":{\"TotalAmount\":{\"BookingCurrencyPrice\":50290,\"EquivCurrencyPrice\":226.31},\"BaseAmount\":{\"BookingCurrencyPrice\":26250,\"EquivCurrencyPrice\":118.13},\"TaxAmount\":{\"BookingCurrencyPrice\":24040,\"EquivCurrencyPrice\":108.18},\"Commission\":{\"AgencyCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"AgencyYqCommission\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"BookingFee\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"PortalCharges\":{\"Markup\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Surcharge\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0},\"Discount\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"Taxes\":[]}},\"ReshopDifferential\":{\"OriginalOrder\":{\"TotalPrice\":{\"BookingCurrencyPrice\":50290,\"EquivCurrencyPrice\":226.3},\"BasePrice\":{\"BookingCurrencyPrice\":26250,\"EquivCurrencyPrice\":118.12},\"TaxPrice\":{\"BookingCurrencyPrice\":24040,\"EquivCurrencyPrice\":108.18}},\"NewOffer\":{\"TotalPrice\":{\"BookingCurrencyPrice\":50290,\"EquivCurrencyPrice\":226.31},\"BasePrice\":{\"BookingCurrencyPrice\":26250,\"EquivCurrencyPrice\":118.13},\"TaxPrice\":{\"BookingCurrencyPrice\":24040,\"EquivCurrencyPrice\":108.18}},\"PenaltyAmount\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0}},\"ReshopDue\":{\"TotalPrice\":{\"BookingCurrencyPrice\":0,\"EquivCurrencyPrice\":0.01}}},\"FareComponent\":[{\"PriceClassRef\":\"PCR_1\",\"SegmentRefs\":\"Segment1\",\"FareBasis\":{\"FareBasisCode\":{\"Refs\":\"FG_1\",\"Code\":\"UELOIA\"},\"RBD\":\"U\",\"CabinType\":\"Y\",\"SeatLeft\":\"7\"}}]}],\"BaggageAllowance\":[{\"SegmentRefs\":\"Segment1\",\"PassengerRefs\":\"ADT1 ADT2\",\"BaggageAllowanceRef\":\"Bag1\"},{\"SegmentRefs\":\"Segment1\",\"PassengerRefs\":\"ADT1 ADT2\",\"BaggageAllowanceRef\":\"Bag1\"},{\"SegmentRefs\":\"Segment1\",\"PassengerRefs\":\"CHD1\",\"BaggageAllowanceRef\":\"Bag1\"}],\"SplitPaymentInfo\":[{\"AirItineraryId\":\"1227102711721375087885644107\",\"MultipleFop\":\"N\",\"MaxCardsPerPax\":0,\"MaxCardsPerPaxInMFOP\":0}],\"BookingToEquivExRate\":0.0045,\"FopRef\":\"FOP_0_0_0_0_ALL_ALL\"}]}],\"DataLists\":{\"PassengerList\":{\"Passengers\":[{\"PassengerID\":\"ADT1\",\"PTC\":\"ADT\",\"NameTitle\":\"Mr\",\"FirstName\":\"RAM\",\"MiddleName\":\"\",\"LastName\":\"KUMAR\",\"DocumentNumber\":\"9101305330348\"},{\"PassengerID\":\"ADT2\",\"PTC\":\"ADT\",\"NameTitle\":\"Mr\",\"FirstName\":\"RAJ\",\"MiddleName\":\"\",\"LastName\":\"KUMAR\",\"DocumentNumber\":\"9101305330347\"},{\"PassengerID\":\"CHD1\",\"PTC\":\"CHD\",\"NameTitle\":\"Mr\",\"FirstName\":\"SHANTHA\",\"MiddleName\":\"\",\"LastName\":\"KUMAR\",\"DocumentNumber\":\"9101305330349\"}]},\"DisclosureList\":{\"Disclosures\":[]},\"FareList\":{\"FareGroup\":[{\"FareGroupRef\":\"FG_1\",\"FareCode\":\"70J\",\"FareBasisCode\":\"UELOIA\"}]},\"FlightSegmentList\":{\"FlightSegment\":[{\"SegmentKey\":\"Segment1\",\"Departure\":{\"AirportCode\":\"MAA\",\"Date\":\"2024-11-16\",\"Time\":\"09:40:00\",\"AirportName\":\"Chennai International Airport\",\"Terminal\":{\"Name\":\"\"}},\"Arrival\":{\"AirportCode\":\"MCT\",\"Date\":\"2024-11-16\",\"Time\":\"12:00:00\",\"AirportName\":\"Muscat International Airport\",\"Terminal\":{\"Name\":\"\"}},\"MarketingCarrier\":{\"AirlineID\":\"WY\",\"Name\":\"Oman Air\",\"FlightNumber\":\"252\"},\"OperatingCarrier\":{\"AirlineID\":\"WY\",\"Name\":\"Oman Air\",\"FlightNumber\":\"252\"},\"Equipment\":{\"AircraftCode\":\"7M8\",\"Name\":\"Boeing 737 MAX 8\"},\"Code\":{\"MarriageGroup\":\"O\"},\"FlightDetail\":{\"FlightDuration\":{\"Value\":\"3 H 50 M\"},\"Stops\":{\"Value\":0},\"InterMediate\":[],\"AirMilesFlown\":0},\"BrandId\":\"\"}]},\"FlightList\":{\"Flight\":[{\"FlightKey\":\"Flight1\",\"Journey\":{\"Time\":\"3 H 50 M\",\"Stops\":0},\"SegmentReferences\":\"Segment1\"}]},\"OriginDestinationList\":{\"OriginDestination\":[{\"OriginDestinationKey\":\"OD1\",\"DepartureCode\":\"MAA\",\"ArrivalCode\":\"MCT\",\"FlightReferences\":\"Flight1\"}]},\"PriceClassList\":{\"PriceClass\":[{\"PriceClassID\":\"PCR_1\",\"Name\":\"\",\"Code\":\"\",\"Descriptions\":{\"Description\":[]}}]},\"BaggageAllowanceList\":{\"BaggageAllowance\":[{\"BaggageAllowanceID\":\"Bag1\",\"BaggageCategory\":\"Checked\",\"AllowanceDescription\":{\"ApplicableParty\":\"Traveler\",\"Description\":\"CHECKED ALLOWANCE\"},\"PieceAllowance\":{\"ApplicableParty\":\"Traveler\",\"TotalQuantity\":\"30\",\"Unit\":\"kg\"}}]},\"FopList\":[{\"CC\":{\"Allowed\":\"N\",\"Types\":{}},\"DC\":{\"Allowed\":\"N\",\"Types\":{}},\"CHEQUE\":{\"Allowed\":\"Y\",\"Types\":{}},\"CASH\":{\"Allowed\":\"Y\",\"Types\":{}},\"ACH\":{\"Allowed\":\"N\",\"Types\":{}},\"PG\":{\"Allowed\":\"Y\",\"Types\":{}},\"FopKey\":\"FOP_0_0_0_0_ALL_ALL\"}]},\"MetaData\":{}}}";

        // Create and add request to flowState
        DateChangePrePaymentRequest request = new DateChangePrePaymentRequest();
        request.setPnr("DX6HXFPE");

        flowState = flowState.toBuilder()
                .addValue(FlowStateKey.REQUEST, request)
                .addValue(FlowStateKey.ODC_EXCHANGE_PRICE_RESPONSE, sampleJson)
                .build();
    }

    @Test
    public void testExchangePriceResponseConversion() throws Exception {
        // Execute the task
        FlowState resultState = task.run(flowState);

        // Get the converted response
        DateChangePrePaymentResponse paymentResponse = resultState.getValue(FlowStateKey.RESPONSE);

        try {
            System.out.println(new ObjectMapper().writeValueAsString(paymentResponse));
        } catch (Exception e) {
            // return ExceptionUtils.getStackTrace(e);
        }
    }
}